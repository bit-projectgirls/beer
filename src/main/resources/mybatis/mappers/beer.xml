<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="beer">
	<!-- 나라 목록 받아오기 -->
	<select id="selectCountry" resultType="map" parameterType="map">
	SELECT * FROM (
    	SELECT ROWNUM AS idx, a.* FROM (
	        SELECT DISTINCT country
	        FROM beer
	        WHERE country Like ('%'|| #{keyword} ||'%')
	        ORDER BY country) a
    	<![CDATA[WHERE ROWNUM <= #{idx} + 20)
	WHERE idx > #{idx}
	]]>
	</select>
	<!-- 맥주 종류 받아오기 -->
	<select id="selectType" resultType="String">
	<![CDATA[
	SELECT DISTINCT type
	FROM beer
	ORDER BY type
	]]>
	</select>
	<!-- 맥주 SELECT by beerNo -->
	<select id="selectBeerByNo" resultType="BeerVo" parameterType="int">
    SELECT *
    FROM beer
    WHERE beerNo = #{beerNo}
	</select>
	<!-- 맥주 SELECT by Filter -->
	<select id="selectBeer" resultType="BeerVo" parameterType="map">
	SELECT * FROM (
		SELECT ROWNUM AS idx, b.* FROM (
			SELECT * FROM beer 
			WHERE beername IS NOT NULL
			<if test="ctrylist != null">
				AND country in
				<foreach item="country" index="index" collection="ctrylist" open="(" separator="," close=")">
				    #{country}
				</foreach>
			</if>
			<if test="minabv != null and maxabv != null">
			    <![CDATA[ AND abv >= #{minabv} AND abv <= #{maxabv} ]]>
			</if>
			<if test="typelist != null">
				AND type in
				<foreach item="type" index="index" collection="typelist" open="(" separator="," close=")">
				    #{type}
				</foreach>
			</if>
			ORDER BY beerno) b
		<![CDATA[WHERE ROWNUM <= #{idx} + 30)
	WHERE idx > #{idx}]]>
	</select>
	<!-- 맥주 SELECT by hashtag -->
	<select id="selectBeerByTag" resultType="BeerVo" parameterType="String">
    SELECT DISTINCT b.beerNo, beerName, beerPic, company, country, type, abv, rating, ratingBA, note
    FROM beer b, hashtag h
    WHERE b.beerNo = h.beerNo AND tagname Like #{keyword}
	</select>
	<!-- 맥주 rating UPDATE -->
	<update id="updateRating" parameterType="map">
	<![CDATA[
	UPDATE beer
	SET rating = #{rating}
	WHERE beerNo = #{beerNo}
	]]>
	</update>
	<!-- 좋아요 INSERT -->
	<insert id="insertLike" parameterType="map">
	<![CDATA[
	INSERT INTO beer_like
	(bLikeNo, uuid, beerNo, regDate)
	VALUES(seq_bLike_no.nextVal, #{uuid}, #{beerNo}, sysdate)
	]]>
	</insert>
	<!-- 맥주 좋아요수 UPDATE -->
	<update id="updateLike" parameterType="map">
	<![CDATA[
	UPDATE beer
	SET likeCnt = likeCnt + 1
	WHERE beerNo = #{beerNo}
	]]>
	</update>
	<!-- 맥주 좋아요수 SELECT -->
	<select id="selectLikeCnt" resultType="int" parameterType="int">
    SELECT count(*)
    FROM beer_like
    WHERE beerNo = #{beerNo}
	</select>
</mapper>